<!DOCTYPE html>
<html>
<head>
	<title>Patcher in Browser</title>
	<meta http-equiv="content-Type" content="text/html; charset=UTF-8"/>
    <style>
        input, textarea { display: block; width: 250px; margin-bottom: 20px; }
        body, body * { background: #444; color: #ccc; }
    </style>
</head>
<body>
    <h2>Patcher in Browser</h2>
    <label for="patches">Offset and bytes (in hexadecimal)</label>
    <textarea id="patches" rows=6>
    1BADC0DE: 41 42 53 54
    DEADBEEF: 31 32 63 64
    F00DFACE: CA FE BA BE
    </textarea>
    <label for="fileInput">File to be patched</label>
    <input type="file" id="fileInput" onchange="readFile(this)" />
    <button id="applyBtn" onclick="patchAndSave()">Apply patch</button>
    <script type="text/javascript">
        var filename, bytes
        function patchAndSave() {
            var error = applyPatch(bytes)
            if (error) alert(error)
            else saveBlob(new Blob([bytes]), filename)
        }
        function applyPatch(bytes) {
            if (!bytes) return 'no file selected' 
            const patches = document.getElementById('patches').value.trim()
            for (var line of patches.split("\n")) {
                if (!line.trim().match(/^[0-9a-f]+\s*:?(\s+[0-9a-f]{2})*$/i)) return 'wrong format: ' + line
                const [offset, ...patch] = line.trim().split(/\s*:?\s+/).map(i => parseInt(i, 16))
                if (offset + patch.length > bytes.length) return 'offset too big: ' + line
                bytes.set(patch, offset)
            }
        }
        async function readFile(fileInput) {
            const file = fileInput.files[0]
            filename = file.name
            bytes = await new Promise(resolve => {
                const reader = new FileReader()
                reader.readAsArrayBuffer(file)
                reader.onload = () => resolve(new Uint8Array(reader.result))
            })
        }
        var saveBlob = (function () {
            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";
            return function (blob, fileName) {
                var url = URL.createObjectURL(blob);
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            };
        }());
    </script>
</body>
</html>
