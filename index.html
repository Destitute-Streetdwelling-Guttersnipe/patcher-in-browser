<!DOCTYPE html>
<html>
<head>
    <title>Patcher in Browser</title>
    <meta http-equiv="content-Type" content="text/html; charset=UTF-8"/>
    <style>
        input, textarea, button { display: block; width: 300px; margin-bottom: 20px; }
        body, body * { background: #444; color: #ccc; }
        .hidden { display: none }
    </style>
</head>
<body>
    <h2><a href="https://github.com/Destitute-Streetdwelling-Guttersnipe/patcher-in-browser">Patcher in Browser</a></h2>
    <h3 id="name"></h3>
    <label for="patches">Offset and bytes (in hexadecimal)</label>
    <textarea id="patches" rows=6>
        BADC0DE:  41   42 53   54
       DEADBEEF   0x31 32  63 0x64
      0xF00DFACE  : CA FE 0xBA  BE
    </textarea>
    <label for="fileInput">File to be patched</label>
    <input type="file" id="fileInput" onchange="readFile(this)" />
    <button id="applyBtn" onclick="patchAndSave()">Apply patch</button>
    <button onclick="toggleComparison()">Compare file</button>
    <div id="comparisonArea" class="hidden">
        <label for="file2Input">File to be compared</label>
        <input type="file" id="file2Input" onchange="compareFile(this)" />
        <label for="changes">Different offset and bytes (in hexadecimal)</label>
        <textarea id="changes" rows=6></textarea>
    </div>
    <script type="text/javascript">
        var filename, bytes, originalBytes
        function patchAndSave() {
            var [error, patched] = applyPatch(bytes)
            if (error) alert(error)
            else saveBlob(new Blob([patched]), filename)
        }
        function applyPatch(bytes) {
            const patches = document.getElementById('patches').value.trim()
            location.hash = '#' + JSON.stringify({name: 'no_name', patches: patches.replaceAll(' ', '-').replaceAll('\n', '.')})
            if (!bytes) return ['no file selected']
            var patched = new Uint8Array(bytes)
            for (var line of patches.split("\n")) {
                if (!line.trim().match(/^(0x)?[0-9a-f]+\s*:?(\s+(0x)?[0-9a-f]{2})*$/i)) return ['wrong format: ' + line]
                const [offset, ...patch] = line.trim().split(/\s*:?\s+/).map(i => parseInt(i, 16))
                if (offset + patch.length > bytes.length) return ['offset too big: ' + line]
                patched.set(patch, offset)
            }
            return [null, patched]
        }
        async function readFile(fileInput) {
            const file = fileInput.files[0]
            filename = file && file.name
            bytes = file && await new Promise(resolve => {
                const reader = new FileReader()
                reader.readAsArrayBuffer(file)
                reader.onload = () => resolve(new Uint8Array(reader.result))
            })
            if (fileInput.id === 'fileInput') {
                originalBytes = bytes // originalBytes has content from fileInput
                if (!bytes) document.getElementById('comparisonArea').classList.add('hidden')
            }
        }
        async function compareFile(file2Input) {
            await readFile(file2Input) // bytes has content from file2Input
            var diff = false
            var patches = ''
            for (var i in bytes) {
                if (bytes[i] === originalBytes[i]) {
                    diff = false
                } else {
                    if (!diff) {
                        diff = true
                        patches += '\n' + parseInt(i).toString(16) + ':'
                    }
                    patches += ' ' + bytes[i].toString(16).padStart(2, '0')
                }
            }
            document.getElementById('changes').value = patches.trim()
        }
        function toggleComparison() {
            if (!bytes) {
                alert('no file selected')
                return
            }
            document.getElementById('comparisonArea').classList.toggle('hidden')
        }
        var saveBlob = (function () {
            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";
            return function (blob, fileName) {
                var url = URL.createObjectURL(blob);
                a.href = url;
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(url);
            };
        }());
        try {
            // example: #{"name":"a_patcher_name","patches":"BADC0DE-41-42-53-54.F00DFACE-CA-FE-BA-BE"}
            var paramStr = decodeURI(location.hash.slice(1))
            if (paramStr && paramStr[0]==='{') {
                var params = JSON.parse(paramStr)
                document.getElementById('name').innerText = params.name
                document.getElementById('patches').value = params.patches.replaceAll('-',' ').replaceAll('.','\n')
            }
        } catch(ex) {
            console.warn('Error: cannot parse parameters from URL hash', ex)
        }
    </script>
</body>
</html>
